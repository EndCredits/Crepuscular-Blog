<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>凛凛的ROM课堂 -- 笔记 | Crepuscular's Blog</title><meta name="author" content="Crepuscular Hans"><meta name="copyright" content="Crepuscular Hans"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前一段 b 站直播凛凛没开麦… 斗胆加上一点点自己的理解（ 基本结构最基础的文件有以下几个  1cce87ff thyme: Initial tree from lisa  1234567891011121314ROOT|-Android.bp|-Android.mk|-AndroidProducts.mk|-BoardConfig.mk|-device.mk|-lineage_thyme.mk|">
<meta property="og:type" content="article">
<meta property="og:title" content="凛凛的ROM课堂 -- 笔记">
<meta property="og:url" content="https://endcredits.github.io/Crepuscular-Blog/post/%E5%87%9B%E5%87%9B%E7%9A%84ROM%E8%AF%BE%E5%A0%82-%E7%AC%94%E8%AE%B0.html">
<meta property="og:site_name" content="Crepuscular&#39;s Blog">
<meta property="og:description" content="前一段 b 站直播凛凛没开麦… 斗胆加上一点点自己的理解（ 基本结构最基础的文件有以下几个  1cce87ff thyme: Initial tree from lisa  1234567891011121314ROOT|-Android.bp|-Android.mk|-AndroidProducts.mk|-BoardConfig.mk|-device.mk|-lineage_thyme.mk|">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/30337499?v=4">
<meta property="article:published_time" content="2022-09-26T04:23:24.000Z">
<meta property="article:modified_time" content="2022-09-27T05:38:25.463Z">
<meta property="article:author" content="Crepuscular Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/30337499?v=4"><link rel="shortcut icon" href="/Crepuscular-Blog/img/favicon.png"><link rel="canonical" href="https://endcredits.github.io/Crepuscular-Blog/post/%E5%87%9B%E5%87%9B%E7%9A%84ROM%E8%AF%BE%E5%A0%82-%E7%AC%94%E8%AE%B0"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/Crepuscular-Blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/Crepuscular-Blog/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '凛凛的ROM课堂 -- 笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-27 13:38:25'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/39017895?v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/Crepuscular-Blog/archives/"><div class="headline">Articles</div><div class="length-num">4</div></a><a href="/Crepuscular-Blog/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/Crepuscular-Blog/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/Crepuscular-Blog/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/Crepuscular-Blog/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/Crepuscular-Blog/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://avatars.githubusercontent.com/u/30337499?v=4')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/Crepuscular-Blog/">Crepuscular's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/Crepuscular-Blog/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/Crepuscular-Blog/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/Crepuscular-Blog/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">凛凛的ROM课堂 -- 笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-09-26T04:23:24.000Z" title="Created 2022-09-26 12:23:24">2022-09-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-09-27T05:38:25.463Z" title="Updated 2022-09-27 13:38:25">2022-09-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="凛凛的ROM课堂 -- 笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>前一段 b 站直播凛凛没开麦… 斗胆加上一点点自己的理解（</p>
<h2 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h2><p>最基础的文件有以下几个 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vcs">cce87ff thyme: Initial tree from lisa<br></code></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">ROOT<br>|-Android.bp<br>|-Android.mk<br>|-AndroidProducts.mk<br>|-BoardConfig.mk<br>|-device.mk<br>|-lineage_thyme.mk<br>|-recovery<br>| |-recovery.fstab<br>|-rootdir<br>| |-Android.mk<br>| |-etc<br>| | |-fstab.qcom<br>| | |-init.recovery.qcom.rc<br></code></pre></td></tr></table></figure>

<p>因为只是初始化了一个设备树的框架，所以比起 Github 上的成品 dt 会显得少很多东西，不要担心，之后我们会根据需要分别加入需要的部分</p>
<h2 id="它们有什么用"><a href="#它们有什么用" class="headerlink" title="它们有什么用?"></a>它们有什么用?</h2><ul>
<li><p>Android.bp</p>
<p>  它定义了一个 soong namespace ，指向你的 dt ，至于什么是 soong namespace … 说来话长，可以理解为让 soong 编译系统能够发现你的 dt 以及里面配置的编译选项，它通常也会用于导入其他的 soong namespace，这样我们就可以选择编译导入的那个 namespace 里定义的模块，例如下面的这个例子，定义了自己的命名空间，以及导入了一个命名空间 <code>hardware/xiaomi</code></p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs blueprint">soong_namespace &#123;<br>    imports: [<br>        &quot;hardware/xiaomi&quot;,<br>    ],<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>Android.mk</p>
<p>  主要用于 blueprint 还不成熟时，定义编译模块。它还会与 <code>make</code> 直接打交道，它通常至少有以下内容 ( 以 <code>picasso</code> 为例 )</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">LOCAL_PATH := <span class="hljs-variable">$(<span class="hljs-built_in">call</span> my-<span class="hljs-built_in">dir</span>)</span><br><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(TARGET_DEVICE)</span>,picasso)<br><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(<span class="hljs-built_in">call</span> all-makefiles-under,<span class="hljs-variable">$(LOCAL_PATH)</span>)</span><br><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(CLEAR_VARS)</span><br><br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure>

<p>  上面的内容告诉 <code>make</code> ，如果定义了 <code>picasso</code>，这个设备，那么调用当前目录下所有的 <code>Makefile</code> 来控制这个产品的编译。 <code>ifeq</code> 等等关键字是 Makefile 语法自带的关键字， <code>my-dir</code>, <code>all-makefiles-under</code>, 是 AOSP 为你预先写好的工具函数，简化你的工作，详细信息可以查阅 AOSP 的文档以及编译系统源代码，这些函数在整个编译系统以及我们设备的定义中会很常见</p>
<p>  Android.mk 还有一个常见的用处就是可以创建一些 <code>symlink</code>，允许我们在编译时就把一些系统必要的挂载点创建好，这对一些服务的启动是必需的，例如 ( 以 <code>picasso</code> 为例 )</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># A/B builds require us to create the mount points at compile time.</span><br><span class="hljs-comment"># Just creating it for all cases since it does not hurt.</span><br>FIRMWARE_MOUNT_POINT := <span class="hljs-variable">$(TARGET_OUT_VENDOR)</span>/firmware_mnt<br><span class="hljs-variable">$(FIRMWARE_MOUNT_POINT)</span>: <span class="hljs-variable">$(LOCAL_INSTALLED_MODULE)</span><br> @echo <span class="hljs-string">&quot;Creating <span class="hljs-variable">$(FIRMWARE_MOUNT_POINT)</span>&quot;</span><br> @mkdir -p <span class="hljs-variable">$(TARGET_OUT_VENDOR)</span>/firmware_mnt<br><br>BT_FIRMWARE_MOUNT_POINT := <span class="hljs-variable">$(TARGET_OUT_VENDOR)</span>/bt_firmware<br><span class="hljs-variable">$(BT_FIRMWARE_MOUNT_POINT)</span>: <span class="hljs-variable">$(LOCAL_INSTALLED_MODULE)</span><br> @echo <span class="hljs-string">&quot;Creating <span class="hljs-variable">$(BT_FIRMWARE_MOUNT_POINT)</span>&quot;</span><br> @mkdir -p <span class="hljs-variable">$(TARGET_OUT_VENDOR)</span>/bt_firmware<br><br>DSP_MOUNT_POINT := <span class="hljs-variable">$(TARGET_OUT_VENDOR)</span>/dsp<br><span class="hljs-variable">$(DSP_MOUNT_POINT)</span>: <span class="hljs-variable">$(LOCAL_INSTALLED_MODULE)</span><br> @echo <span class="hljs-string">&quot;Creating <span class="hljs-variable">$(DSP_MOUNT_POINT)</span>&quot;</span><br> @mkdir -p <span class="hljs-variable">$(TARGET_OUT_VENDOR)</span>/dsp<br><br>ALL_DEFAULT_INSTALLED_MODULES += <span class="hljs-variable">$(FIRMWARE_MOUNT_POINT)</span> <span class="hljs-variable">$(BT_FIRMWARE_MOUNT_POINT)</span> <span class="hljs-variable">$(DSP_MOUNT_POINT)</span><br><br></code></pre></td></tr></table></figure>
<p>  这里定义了 firmware 的挂载点，在编译初期你会看到</p>
  <figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">Creating</span></span> xxxx mount point ...<br></code></pre></td></tr></table></figure>

<p>  就是它们在起作用</p>
<p>  对于高通设备，这些内容通常都可以在 CLO 对应的 Soc 仓库中找到</p>
</li>
<li><p>AndroidProducts.mk</p>
<p>  它的作用是让你的设备能够被 AOSP 编译系统识别，也就是定义了你在使用 <code>lunch</code> 命令的时候，后面应该传递的参数，内容通常比较简单。</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">PRODUCT_MAKEFILES := \<br>    <span class="hljs-variable">$(LOCAL_DIR)</span>/aosp_picasso.mk<br><br>COMMON_LUNCH_CHOICES := \<br>    aosp_picasso-userdebug \<br>    aosp_picasso-eng<br></code></pre></td></tr></table></figure>

<p>  以前的编译系统还会用到 <code>add_lunch_combo</code> 这个函数，不过现在已经被弃用了，改成了定义 <code>COMMON_LUNCH_CHOICES</code> (如上代码框所示)</p>
</li>
<li><p>lineage_thyme.mk</p>
<p>  这里定义了跟你设备有关的信息，比如它叫什么名字，是什么牌子的，编译它时应该继承哪些配置文件，特点是什么，GMS Client Base 等等，同样地，以编译我的 AOSP 的 <code>picasso</code> 为例</p>
<p>  <code>aosp_picasso.mk</code></p>
<p>  可以看到，这个文件的命名是有规律的，下划线前面的部分通常是你要编译的 rom 的代号，下划线后面的部分通常是你的设备代号，这个文件的名字应该与上面定义在 <code>AndroidProducts.mk</code> 里 <code>PRODUCT_MAKEFILES</code> 的名字一致</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Inherit from those products. Most specific first.</span><br><span class="hljs-variable">$(<span class="hljs-built_in">call</span> inherit-product, <span class="hljs-variable">$(SRC_TARGET_DIR)</span>/product/core_64_bit.mk)</span><br><span class="hljs-variable">$(<span class="hljs-built_in">call</span> inherit-product, <span class="hljs-variable">$(SRC_TARGET_DIR)</span>/product/full_base_telephony.mk)</span><br><br><span class="hljs-comment"># Inherit from picasso device</span><br><span class="hljs-variable">$(<span class="hljs-built_in">call</span> inherit-product, device/xiaomi/picasso/device.mk)</span><br><br><span class="hljs-comment"># Inherit some common AOSP stuff.</span><br><span class="hljs-variable">$(<span class="hljs-built_in">call</span> inherit-product, vendor/aosp/config/common.mk)</span><br><br><span class="hljs-comment"># Add some Crepuscular AOSP Feature</span><br>TARGET_SUPPORTS_QUICK_TAP := true<br>TARGET_FACE_UNLOCK_SUPPORTED := true<br>TARGET_INCLUDE_PIXEL_CHARGER := true<br><br><span class="hljs-comment"># Device identifier. This must come after all inclusions.</span><br>PRODUCT_NAME := aosp_picasso<br>PRODUCT_DEVICE := picasso<br>PRODUCT_MODEL := Redmi K30 5G<br>PRODUCT_BRAND := Redmi<br>PRODUCT_MANUFACTURER := Xiaomi<br><br>TARGET_BOOT_ANIMATION_RES := 1080<br><br>PRODUCT_GMS_CLIENTID_BASE := android-xiaomi<br></code></pre></td></tr></table></figure>
<p>  英语好的同学应该已经可以明白上面的东西定义的是什么了，它们的名字比较直球的表示了它们的作用</p>
<p>  首先是继承 AOSP 产品级配置文件</p>
<p>  <code>$ANDROID_ROOT/build/make/target/product/core_64_bit.mk</code><br>  <code>$ANDROID_ROOT/build/make/target/product/full_base_telephony.mk</code></p>
<p>  有兴趣的同学可以去查阅以下源代码它们到底定义了什么，总结一下就是集合了 Android 整个系统的绝大部分代码</p>
<p>  然后就是继承你的设备配置文件</p>
<p>  <code>$ANDROID_ROOT/device/xiaomi/picasso/device.mk</code></p>
<p>  这个文件待会还会讲到，里面定义了什么 HAL 以及其他杂七杂八的必要组件应该被编译进你的系统</p>
<p>  然后就是继承你的 rom 的配置文件，这里面通常包含了 ROM 特有的一些附加功能，以及一些对 AOSP 编译系统必要的补充，比如支持内核的编译等等</p>
<p>  <code>$ANDROID_ROOT/vendor/aosp/config/common.mk</code></p>
<p>  下面的就顾名思义就可以了，意义比较直球</p>
</li>
<li><p>BoardConfig.mk</p>
<p>  比较重要的文件，定义了你的设备的所有的板级细节，这里也是凛凛着重讲解的一部分</p>
<p>  代码比较多，我们分块来读 ( Dyncmic A-only 设备以 picasso 为例，AB 设备以 thyme 为例)</p>
<p>  首先是架构体系相关的信息（ 同一个 platform 的设备这里可以直接抄，以 <code>picasso</code> 为例 ）</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Architecture</span><br>TARGET_ARCH := arm64<br>TARGET_ARCH_VARIANT := armv8-a<br>TARGET_CPU_ABI := arm64-v8a<br>TARGET_CPU_ABI2 :=<br>TARGET_CPU_VARIANT := cortex-a76<br><br>TARGET_2ND_ARCH := arm<br>TARGET_2ND_ARCH_VARIANT := armv8-a<br>TARGET_2ND_CPU_ABI := armeabi-v7a<br>TARGET_2ND_CPU_ABI2 := armeabi<br>TARGET_2ND_CPU_VARIANT := cortex-a76<br></code></pre></td></tr></table></figure>

<p>  这里定义了你的 Soc 是什么体系结构以及它所使用的变体，比如 <code>picasso</code> 是 <code>lito</code> 也就是 <code>sm7250</code> 平台，那么它的定义就是上面那个样子，如果你相关的平台还没有设备有设备树的话，那么这些信息去 Google 以下具体的 CPU 型号也都可以查的到</p>
<p>  然后是 <code>bootloader</code> 的名字</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Bootloader</span><br>TARGET_BOOTLOADER_BOARD_NAME := lito<br></code></pre></td></tr></table></figure>

<p>  它定义了你的 Soc 的代号，可以通过这个命令查到</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell getprop ro.board.platform<br></code></pre></td></tr></table></figure>
<p>  或者也可以像凛凛直播中讲的那样，去把它的信息 dump 出来然后翻 prop，来定义它，这里定义它的作用主要是为了编译一些跟你 Soc 相关的 HAL ，比如 <code>audio | display | media</code> 都会用到这个</p>
<p>  下面是 <code>A/B</code> 机型特别所需的内容</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># A/B</span><br>AB_OTA_UPDATER := true<br><br>AB_OTA_PARTITIONS += \<br>    boot \<br>    dtbo \<br>    odm \<br>    product \<br>    system \<br>    system_ext \<br>    vbmeta \<br>    vbmeta_system \<br>    vendor_boot \<br>    vendor<br></code></pre></td></tr></table></figure>


<p>  上面的 <code>AB_OTA_UPDATER</code> 标志你的设备支持 AB 无缝系统更新， Legacy AB |  Dynamic AB | Virtual AB 都会需要这个，下面的 <code>AB_OTA_PARTITIONS</code> 定义了你的设备具有 AB 槽位的分区，这些分区会以 xxx_a 和 xxx_b 的形式出现在你的分区表里，你可以通过 <code>fastboot</code> 返回的信息确认你有哪些分区采用了 ab 架构</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">fastboot getvar all<br></code></pre></td></tr></table></figure>
<p>  下面是内核的编译选项 (以 <code>picasso</code> 为例)</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Kernel</span><br>BOARD_KERNEL_CMDLINE := console=ttyMSM0,115200n8 androidboot.hardware=qcom androidboot.console=ttyMSM0 androidboot.memcg=1 lpm_levels.sleep_disabled=1 msm_rtb.filter=0x237 service_locator.enable=1 androidboot.usbcontroller=a600000.dwc3 swiotlb=2048 cgroup.memory=nokmem,nosocket loop.max_part=7 reboot=panic_warm<br>BOARD_KERNEL_CMDLINE += androidboot.init_fatal_reboot_target=recovery<br><span class="hljs-comment"># BOARD_KERNEL_CMDLINE += androidboot.selinux=permissive</span><br>BOARD_KERNEL_IMAGE_NAME := Image<br>BOARD_BOOTIMG_HEADER_VERSION := 2<br>BOARD_KERNEL_BASE := 0x00000000<br>BOARD_KERNEL_PAGESIZE := 4096<br>BOARD_KERNEL_SEPARATED_DTBO := true<br>BOARD_MKBOOTIMG_ARGS += --header_version <span class="hljs-variable">$(BOARD_BOOTIMG_HEADER_VERSION)</span><br>TARGET_KERNEL_ADDITIONAL_FLAGS := DTC_EXT=<span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span>/prebuilts/misc/<span class="hljs-variable">$(HOST_OS)</span>-x86/dtc/dtc<br>TARGET_KERNEL_VERSION := 4.19<br>TARGET_KERNEL_CLANG_COMPILE := true<br>TARGET_KERNEL_SOURCE := kernel/xiaomi/sm7250<br>TARGET_KERNEL_CONFIG := vendor/picasso_user_defconfig<br><br></code></pre></td></tr></table></figure>

<p>  内核编译是相对重要的一段，这里给出的实例是 oss kernel 的编译配置，prebuilt kernel 将会在下面给出</p>
<p>  其中的 <code>BOARD_KERNEL_CMDLINE</code> 定义了传递给内核的可以理解为启动参数的命令行，这些当然不可能是我们默写出来的，它可以通过解包厂商 rom 里的 boot.img 得到，或者也可以通过 adb shell 查询</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell <span class="hljs-built_in">cat</span> /proc/cmdline<br></code></pre></td></tr></table></figure>
<p>  如果想要解包 boot 的话可以使用 unpackbootimg，使用方法可以查阅 <a target="_blank" rel="noopener" href="https://github.com/anestisb/android-unpackbootimg">anestisb&#x2F;android-unpackbootimg</a></p>
<p>  或者提供一个更好解包工具集 <a target="_blank" rel="noopener" href="https://github.com/ShivamKumarJha/android_tools">ShivamKumarJha&#x2F;android_tools</a></p>
<p>  然后是你的 <code>BOARD_KERNEL_IMAGE_NAME</code> ，这里定义了你的内核编译产物是什么，对于 4.19 平台，如果没有开启压缩的话，默认都是 <code>Image</code>，开启压缩可能是 <code>Image.gz</code>，对于 4.9 及以下的平台 ( 使用 bootheader v1 的设备 )，编译产物可能是 <code>Image.gz-dtb</code> 或者 <code>Image-dtb</code> ，它们的 dtb 附加在内核文件的后面，这一点可以查看你的内核 <code>defconfig</code> 是否开启了<code>CONFIG_BUILD_ARM64_APPENDED_DTB_IMAGE</code>，如果开启，那么就使用连接 dtb 的形式，如果没有开启这个而是开启了 <code>CONFIG_BUILD_ARM64_DT_OVERLAY</code>，说明你的 bootheader version 至少在 v2 及以上，那么就使用单独的 <code>Image</code> 形式</p>
<p>  bootheader 版本也可以通过解包 boot.img 得到</p>
<p>  关于 bootheader 的更多详细信息，请查阅: <a target="_blank" rel="noopener" href="https://source.android.com/docs/core/architecture/bootloader/boot-image-header">Boot Image Header - Android Open Source Project</a>，这里只做简单讲解，注意，以下直到讲解结束的 Android 版本均指设备出厂时的 Android 版本</p>
<p>  Boot Image Header 定义了一系列 Android 引导加载程序所使用的标准，在 Android 9 之前，它属于 bootheader v0</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">boot_img_hdr</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint8_t</span> magic[BOOT_MAGIC_SIZE];<br>    <span class="hljs-type">uint32_t</span> kernel_size;                <span class="hljs-comment">/* size in bytes */</span><br>    <span class="hljs-type">uint32_t</span> kernel_addr;                <span class="hljs-comment">/* physical load addr */</span><br><br>    <span class="hljs-type">uint32_t</span> ramdisk_size;               <span class="hljs-comment">/* size in bytes */</span><br>    <span class="hljs-type">uint32_t</span> ramdisk_addr;               <span class="hljs-comment">/* physical load addr */</span><br><br>    <span class="hljs-type">uint32_t</span> second_size;                <span class="hljs-comment">/* size in bytes */</span><br>    <span class="hljs-type">uint32_t</span> second_addr;                <span class="hljs-comment">/* physical load addr */</span><br><br>    <span class="hljs-type">uint32_t</span> tags_addr;                  <span class="hljs-comment">/* physical addr for kernel tags */</span><br>    <span class="hljs-type">uint32_t</span> page_size;                  <span class="hljs-comment">/* flash page size we assume */</span><br>    <span class="hljs-type">uint32_t</span> unused;<br>    <span class="hljs-type">uint32_t</span> os_version;<br>    <span class="hljs-type">uint8_t</span> name[BOOT_NAME_SIZE];        <span class="hljs-comment">/* asciiz product name */</span><br>    <span class="hljs-type">uint8_t</span> cmdline[BOOT_ARGS_SIZE];<br>    <span class="hljs-type">uint32_t</span> id[<span class="hljs-number">8</span>];                      <span class="hljs-comment">/* timestamp / checksum / sha1 / etc */</span><br>    <span class="hljs-type">uint8_t</span> extra_cmdline[BOOT_EXTRA_ARGS_SIZE];<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>  它有一个 <code>uint32_t</code> 类型的 <code>unused</code> 的保留字段</p>
<p>  Android 9 正式支持了 bootheader 这一特性，其将保留字段更新为 <code>header_version</code> ，并新增了以下内容，该特性是 VTS 的强制要求</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">boot_img_hdr</span></span><br><span class="hljs-class">&#123;</span><br>    ...<br>    <span class="hljs-type">uint32_t</span> page_size;                  <span class="hljs-comment">/* flash page size we assume */</span><br>    <span class="hljs-type">uint32_t</span> header_version;<br>    <span class="hljs-type">uint32_t</span> os_version;<br>    ...<br>    <span class="hljs-type">uint32_t</span> recovery_[dtbo|acpio]_size;    <span class="hljs-comment">/* size of recovery image */</span><br>    <span class="hljs-type">uint64_t</span> recovery_[dtbo|acpio]_offset;  <span class="hljs-comment">/* offset in boot image */</span><br>    <span class="hljs-type">uint32_t</span> header_size;               <span class="hljs-comment">/* size of boot image header in bytes */</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>  这时候设备就可以添加用于 recovery 的 dtbo | acpio 的内容了</p>
<p>  在 Android 10 ， bootheader 更新到了 v2，添加了 dtb 相关信息的字段</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">boot_img_hdr</span></span><br><span class="hljs-class">&#123;</span><br>    ...<br>    <span class="hljs-type">uint32_t</span> header_size;               <span class="hljs-comment">/* size of boot image header in bytes */</span><br>    <span class="hljs-type">uint32_t</span> dtb_size;                  <span class="hljs-comment">/* size of dtb image */</span><br>    <span class="hljs-type">uint64_t</span> dtb_addr;                  <span class="hljs-comment">/* physical load address */</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>  可以看到，这个时候 dtb 从内核上分离了出来，有了单独的存储区域，这也是为什么不再使用在内核后连接 dtb 的编译形式，<code>CONFIG_BUILD_ARM64_APPENDED_DTB_IMAGE</code> 也就不会被打开了</p>
<p>  而 Android 11 ，bootheader 更新至 v3，改动较大</p>
<ol>
<li>移除了第二阶段引导加载程序的相关信息</li>
<li>移除了 recovery 分区的相关信息</li>
<li>移除了 dtb 的相关信息</li>
</ol>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">boot_img_hdr</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BOOT_MAGIC_SIZE 8</span><br>    <span class="hljs-type">uint8_t</span> magic[BOOT_MAGIC_SIZE];<br><br>    <span class="hljs-type">uint32_t</span> kernel_size;    <span class="hljs-comment">/* size in bytes */</span><br>    <span class="hljs-type">uint32_t</span> ramdisk_size;   <span class="hljs-comment">/* size in bytes */</span><br><br>    <span class="hljs-type">uint32_t</span> os_version;<br><br>    <span class="hljs-type">uint32_t</span> header_size;    <span class="hljs-comment">/* size of boot image header in bytes */</span><br>    <span class="hljs-type">uint32_t</span> reserved[<span class="hljs-number">4</span>];<br>    <span class="hljs-type">uint32_t</span> header_version; <span class="hljs-comment">/* offset remains constant for version check */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BOOT_ARGS_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BOOT_EXTRA_ARGS_SIZE 1024</span><br>    <span class="hljs-type">uint8_t</span> cmdline[BOOT_ARGS_SIZE + BOOT_EXTRA_ARGS_SIZE];<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>  这个时候，AB 设备中的 recovery 分区被合并进了 boot 分区，也就没有必要再指定 recovery 所使用的 dtbo | acpio，原本属于 bootheader 中的内容的 dtb 被放置到了 vendor_boot 分区中，所以也没有必要再放置有关 dtb 的信息</p>
<p>  至于 vendor_boot ，是在 Android 11 中为兼容 GKI 而引入的新分区，所有 OEM 的修改都被分离到 vendor_boot 中，剩余部分使用 AOSP 通用内核的编译产物</p>
<p>  而 A only 设备则只能止步于此，因为使用单独的 recovery 分区和 boot 分区，所以它们只能使用到 bootheader v2</p>
<p>  到 Android 12 ， bootheader 更新至了 v4</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">boot_img_hdr</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BOOT_MAGIC_SIZE 8</span><br>    <span class="hljs-type">uint8_t</span> magic[BOOT_MAGIC_SIZE];<br><br>    <span class="hljs-type">uint32_t</span> kernel_size;    <span class="hljs-comment">/* size in bytes */</span><br>    <span class="hljs-type">uint32_t</span> ramdisk_size;   <span class="hljs-comment">/* size in bytes */</span><br><br>    <span class="hljs-type">uint32_t</span> os_version;<br><br>    <span class="hljs-type">uint32_t</span> header_size;    <span class="hljs-comment">/* size of boot image header in bytes */</span><br>    <span class="hljs-type">uint32_t</span> reserved[<span class="hljs-number">4</span>];<br>    <span class="hljs-type">uint32_t</span> header_version; <span class="hljs-comment">/* offset remains constant for version check */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BOOT_ARGS_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BOOT_EXTRA_ARGS_SIZE 1024</span><br>    <span class="hljs-type">uint8_t</span> cmdline[BOOT_ARGS_SIZE + BOOT_EXTRA_ARGS_SIZE];<br><br>    <span class="hljs-type">uint32_t</span> signature_size; <span class="hljs-comment">/* size in bytes */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>  新增了一个 <code>uint32_t</code> 类型的 <code>boot_signature</code> 字段，用于验证内核和 ramdisk 的完整性，但须注意的是，该字段并不参与 AVB 的启动过程而只由 VTS 测试使用</p>
<p>  bootheader v4 同时还支持了分段的 vendor_boot 分区</p>
<p>  关于 bootheader 的讨论到此结束，剩余部分请查阅 AOSP 项目文档</p>
<p>  同理，上面中的 <code>BOARD_KERNEL_BASE</code> 和 <code>BOARD_KERNEL_PAGESIZE</code> 也可以从 <code>unpackbootimg</code> 中的输出信息中得到</p>
<p>  事实上，像凛凛佬直播中使用的 <code>magiskboot</code> 程序会有更加良好的格式化以及更佳的可读性，同样也推荐使用</p>
<p>  对于 <code>BOARD_KERNEL_SEPARATED_DTBO</code>，这个 flag 在有独立的 dtbo 分区的设备上是必须打开的，它控制编译系统是否支持以及编译单独的 dtbo 分区</p>
<p>  而 <code>BOARD_MKBOOTIMG_ARGS</code> 则是在生成 <code>boot.img</code> 时，传递给 <code>mkbootimg</code> 程序的参数，比如上述参数</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">BOARD_MKBOOTIMG_ARGS += --header_version <span class="hljs-variable">$(BOARD_BOOTIMG_HEADER_VERSION)</span><br></code></pre></td></tr></table></figure>
<p>  意思就是给 <code>mkbootimg</code> 传入一个 –header_version 的参数，后面的是你的 bootheader version，已经在之前定义过了</p>
<p>  下面的 <code>TARGET_KERNEL_ADDITIONAL_FLAGS</code> 则是在编译内核 <code>Image</code> 的时候，要传递给 <code>make</code> 程序的额外参数，比如上文中给出的</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">TARGET_KERNEL_ADDITIONAL_FLAGS := DTC_EXT=<span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span>/prebuilts/misc/<span class="hljs-variable">$(HOST_OS)</span>-x86/dtc/dtc<br></code></pre></td></tr></table></figure>
<p>  其中 <code>pwd</code> 指令是自己当前所在的目录，这样展开其实就是 <code>$ANDROID_ROOT/prebuilts/misc/linux-x86/dtc/dtc</code> 传入这一句的意思是向 <code>make</code> 程序说明，我们不希望使用内核源码中自带的 dtc ( device tree compiler | 内核设备树编译器 ) 编译内核的 dts，而是使用这个外部的预编译的 dtc ，这样做一方面是可以避免因为 dtc 版本不同而导致语法的不兼容，避免编译失败，也可以节约使用 HOSTCC 编译 dtc 的时间 ( 虽然说这个时间成本跟编译整个系统比起来要低很多就是了… )</p>
<p>  有的时候我们还需要用这个 flag 来传递一些信息，比如我们可以传入</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">TARGET_KERNEL_ADDITIONAL_FLAGS += OBJDUMP=llvm-objdump<br></code></pre></td></tr></table></figure>
<p>  这一句的意思是我们想要使用 LLVM 的 <code>objdump</code> 程序而不是用 <code>gcc</code> 的</p>
<p>  而最后面的三个 flag 就比较易懂了，它们的作用已经写在了它们的名字里</p>
<p>  内核部分结束了，然后是分区的定义</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Metadata</span><br>BOARD_USES_METADATA_PARTITION := true<br></code></pre></td></tr></table></figure>
<p>  这个 flag 指定了你需不需要用 <code>metadata</code> 分区进行加密，现在采用 FBEv1&#x2F;v2 的机器基本上都会使用这个分区，同样地 <code>fastboot</code> 程序返回的数据里也会有关于这个分区的信息，视情况打开它就好</p>
<p>  下面的是 oss vendor 所使用的分区信息<br>  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Partitions</span><br>BOARD_BOOTIMAGE_PARTITION_SIZE := 134217728<br>BOARD_CACHEIMAGE_PARTITION_SIZE := 402653184<br>BOARD_DTBOIMG_PARTITION_SIZE := 33554432<br>BOARD_RECOVERYIMAGE_PARTITION_SIZE := 134217728<br>BOARD_USERDATAIMAGE_PARTITION_SIZE := 114919714816<br><br>BOARD_SUPER_PARTITION_SIZE := 9126805504<br>BOARD_SUPER_PARTITION_GROUPS := qti_dynamic_partitions<br>BOARD_QTI_DYNAMIC_PARTITIONS_PARTITION_LIST := system system_ext product odm vendor<br>BOARD_QTI_DYNAMIC_PARTITIONS_SIZE := 9122611200<br><br>BOARD_FLASH_BLOCK_SIZE := 262144<br><br>BOARD_CACHEIMAGE_FILE_SYSTEM_TYPE := ext4<br>BOARD_ODMIMAGE_FILE_SYSTEM_TYPE := erofs<br>BOARD_PRODUCTIMAGE_FILE_SYSTEM_TYPE := erofs<br>BOARD_SYSTEM_EXTIMAGE_FILE_SYSTEM_TYPE := erofs<br>BOARD_SYSTEMIMAGE_FILE_SYSTEM_TYPE := erofs<br>BOARD_VENDORIMAGE_FILE_SYSTEM_TYPE := erofs<br><br>BOARD_EROFS_PCLUSTER_SIZE := 65536<br>BOARD_EROFS_USE_ZTAILPACKING := true<br><br>TARGET_COPY_OUT_ODM := odm<br>TARGET_COPY_OUT_PRODUCT := product<br>TARGET_COPY_OUT_SYSTEM_EXT := system_ext<br>TARGET_COPY_OUT_VENDOR := vendor<br></code></pre></td></tr></table></figure><br>  首先是第一组数据，定义了 <code>boot, cache, dtbo, recovery, userdata</code> 这几个分区的大小，这些属性同样也都会在你执行 <code>fastboot getvar all</code> 的时候悉数返回给你，只不过返回的值是 16 进制的，你需要用一些工具把它转换成 10 进制</p>
<p>  第二组中，<code>BOARD_SUPER_PARTITION_SIZE</code> 定义了你的 super 分区的大小，获取方式同上，需要注意的是，只有在使用动态分区的设备上，第二块内容的定义才是必要的，否则如果没有使用动态分区，那么不需要定义 <code>DYNAMIC_PARTITIONS</code> 的相关属性</p>
<p>  特别地，如果你的设备使用了 bootheader v3&#x2F;v4 并且拥有 <code>vendor_boot</code> 分区，那么你还需要定义 <code>BOARD_VENDOR_BOOT_PARTITIONS_SIZE</code> 这个 flag 来告诉编译系统 <code>vendor_boot</code> 分区的大小</p>
<p>  其中还有一个 flag ，<code>BOARD_QTI_DYNAMIC_PARTITIONS_PARTITION_LIST</code> 定义了你的 super 分区中有哪些子分区，比如对于我们的 oss vendor 的编译需求，我们会需要去尽可能多的减少底包对我们的稳定性，所以我们需要将 super 分区里的全部内容都修改成我们需要的，也就是说我们编译我们需要的分区并且放进去，比如我们下面最后一组数据定义了我们会自行编译哪些分区的镜像，可以看到，有 <code> vendor product system_ext odm</code> 当然还有最重要的 <code>system</code> ，所以我们把它们写入动态分区的列表中，告诉编译系统，生成 super 分区镜像的时候需要把哪些子分区的镜像一起打包进去</p>
<p>  而对于 prebuit vendor ，不需要编译那么多东西，通常只需要 <code>system product system_ext</code> 就可以了</p>
<p>  至于名字为什么是 <code>QTI_DYNAMIC_PARTITIONS</code> ，这都不要紧，可以自己定义一个，比如上面 <code>BOARD_SUPER_PARTITION_GROUPS</code> flag 定义的是 <code>qti_dynamic_partitions</code> ，我可以改成 <code>picasso_dynamic_partitions</code>，只不过把所有的 <code>QTI_DYNAMIC_PARTITIONS</code> 都换成 <code>PICASSO_DYNAMIC_PARTITIONS</code> 就可以了</p>
<p>  而对于 <code>BOARD_QTI_DYNAMIC_PARTITIONS_SIZE</code> 的计算方法</p>
<ul>
<li>Virtual AB:  <code>BOARD_QTI_DYNAMIC_PARTITIONS_SIZE</code> &#x3D; <code>BOARD_SUPER_PARTITION_SIZE</code> - <code>overhead</code></li>
<li>AB: <code>BOARD_QTI_DYNAMIC_PARTITIONS_SIZE</code> &#x3D; <code>BOARD_SUPER_PARTITION_SIZE</code> &#x2F; 2  - <code>overhead</code></li>
<li>non-AB: <code>BOARD_QTI_DYNAMIC_PARTITIONS_SIZE</code> &#x3D; <code>BOARD_SUPER_PARTITION_SIZE</code> - <code>overhead</code></li>
</ul>
<p>  其中 overhead 通常等于 4MB ，注意减去该值时需要将 MB 转化为 byte 才可以相减</p>
<p>  下面的 <code>BOARD_FLASH_BLOCK_SIZE</code> 会定义在你的 boot.img 里，使用 <code>unpackbootimg</code> 工具可以看到这个值，它用于告诉 <code>fastboot</code> 它最大能一次刷入多少大小的东西，如果分区镜像文件的总大小超过了这个值，那就需要分步刷入，比如分成 7 次，每次刷入一点，这个值可以比 boot.img 中提取得到的值小，但绝对不能大，如果设置过大的话会导致无法刷入</p>
<p>  第四组 flags 则是定义了你需要用什么样的分区格式，与 fstab 中的保持一致就好，需要注意的是，使用 <code>erofs</code> 文件系统需要内核支持，如若不支持请不要用 <code>erofs</code></p>
<p>  最后一组就是定义了这些分区最终的编译产物的输出目录，copy 就好</p>
<p>  然后是一些杂项</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Platform</span><br>BOARD_USE_QCOM_HARDWARE := true<br>TARGET_BOARD_PLATFORM := lito<br></code></pre></td></tr></table></figure>
<p>  前一个比较明显，高通设备打开就好了，后面的那个跟你的 <code>TARGET_BOOTLOADER_BOARD_NAME</code> 保持一致就好了</p>
<p>  然后是 Recovery 相关的配置</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Makefile">&gt;&gt;&gt;&gt;&gt;&gt;&gt; picasso: Recovery Section<br><span class="hljs-comment"># Recovery</span><br>BOARD_INCLUDE_DTB_IN_BOOTIMG := true<br>BOARD_INCLUDE_RECOVERY_DTBO := true<br>TARGET_RECOVERY_FSTAB := <span class="hljs-variable">$(DEVICE_PATH)</span>/rootdir/etc/fstab.emmc<br>TARGET_RECOVERY_PIXEL_FORMAT := <span class="hljs-string">&quot;BGRA_8888&quot;</span><br>TARGET_USERIMAGES_USE_EXT4 := true<br>TARGET_USERIMAGES_USE_F2FS := true<br>========<br><span class="hljs-comment"># Recovery</span><br>BOARD_INCLUDE_RECOVERY_DTBO := true<br>BOARD_USES_RECOVERY_AS_BOOT := true<br>TARGET_NO_RECOVERY := true<br>TARGET_RECOVERY_FSTAB := <span class="hljs-variable">$(DEVICE_PATH)</span>/recovery/recovery.fstab<br>TARGET_RECOVERY_PIXEL_FORMAT := <span class="hljs-string">&quot;RGBX_8888&quot;</span><br>TARGET_USERIMAGES_USE_EXT4 := true<br>TARGET_USERIMAGES_USE_F2FS := true<br>&lt;&lt;&lt;&lt;&lt;&lt;&lt; thyme: Recovery Section<br></code></pre></td></tr></table></figure>

<p>  可以看到差别不是很大，而且 flag 的名字也比较易懂，就只介绍 non-AB 和 AB 有什么异同点</p>
<p>  对于 bootheader v2 及以上的具有独立 dtbo 分区的设备而言，<code>BOARD_INCLUDE_RECOVERY_DTBO</code> 需要打开，这一点 <code>picasso</code> 是 v2，<code>thyme</code> 是 v3，所以它们都启用了这个 flag，<code>BOARD_INCLUDE_DTB_IN_BOOTIMG</code> 在 <code>picasso</code> 的配置中打开了，但是 <code>thyme</code> 没有打开，原因可以参照前文的 bootheader v3 发生的变化，它的 dtb 不再包含在 boot 分区中，而是移动到了 <code>vendor_boot</code> 分区里，所以 <code>boot.img</code> 里是不含 dtb 的，然后就是 <code>BOARD_USES_RECOVERY_AS_BOOT</code> 和 <code>TARGET_NO_RECOVERY</code> ，同样地，这个时候 AB 分区的手机不再有独立的 recovery 分区，而是合并进了 boot 分区，所以 <code>thyme</code> 打开了这两个 flag 而 <code>picasso</code> 没有</p>
<p>  下面介绍它们共有的 flags</p>
<p>  首先是 <code>TARGET_RECOVERY_FSTAB</code> ，它指定了你的 recovery 在挂载分区的时候应该使用哪个 fstab ，可以看到这里 <code>picasso</code> 直接复用了编译进系统的 fstab ，而 <code>thyme</code> 则是单独摘了一个出来，都可以</p>
<p>  然后是 <code>TARGET_RECOVERY_PIXEL_FORMAT</code>，它描述了你的 recovery 使用什么样的像素格式，像凛凛视频里那样介绍的拿取这个 flag 的值就好，或者也可以直接 copy 别的，影响不大</p>
<p>  然后两个 flags 指定了你的 userdata 分区的格式，顾名思义即可</p>
<p>  Android Verified Boot 的话… 直接去看 AOSP 的文档就好了，看看每一项都有什么作用</p>
<p>  BoardConfig.mk 的内容肯定不止有这一点点，之后我们还会再加入，以完善这个设备树</p>
</li>
<li><p>device.mk</p>
<p>  这个文件里主要定义了你需要编译进系统里的各种软件包，库文件，配置文件等等，你的大部分精力基本上都是花在这些东西上的，下面来分解一下它的内容</p>
<p>  首先是 include 外部的 Makefile ，它们一般是这个格式</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Installs gsi keys into ramdisk, to boot a GSI with verified boot.</span><br><span class="hljs-variable">$(<span class="hljs-built_in">call</span> inherit-product, <span class="hljs-variable">$(SRC_TARGET_DIR)</span>/product/developer_gsi_keys.mk)</span><br></code></pre></td></tr></table></figure>
<p>  需要注意的是凛凛直播中说到的 Updatable APEX ( 不是 APEX Legend !!! ) 我们使用 oss vendor 一般都不会打开，因为 ROM 优化的 jemalloc 或者 mimalloc 都在这里面， update 了之后就没了，而且在一些设备上还会造成 <code>bootloop</code>，所以这里不多提了，不过它是很好的虚拟化和容器化的例子，感兴趣的话可以学习一下</p>
<p>  当然说 prebuilt 必须要加上这个，毕竟它 vendor 自带的 apex 多半是我们不能用的，所以要 update 成我们自己的</p>
<p>  下面是 thyme 等 VAB 机型必须加入的内容</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Virtual A/B</span><br>ENABLE_VIRTUAL_AB := ture<br><span class="hljs-variable">$(<span class="hljs-built_in">call</span> inherit-product, <span class="hljs-variable">$(SRC_TARGET_DIR)</span>/product/virtual_ab_ota.mk)</span><br></code></pre></td></tr></table></figure>
<p>  意思比较一目了然，表明你的设备支持并使用了 Virtual A&#x2F;B 分区布局，如果不是 VAB 的话这里不需要加</p>
<p>  然后是 Dalvik VM 堆内存的配置</p>
  <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"># Setup dalvik vm configs<br><span class="hljs-constructor">$(<span class="hljs-params">call</span> <span class="hljs-params">inherit</span>-<span class="hljs-params">product</span>, <span class="hljs-params">frameworks</span><span class="hljs-operator">/</span><span class="hljs-params">native</span><span class="hljs-operator">/</span><span class="hljs-params">build</span><span class="hljs-operator">/</span><span class="hljs-params">phone</span>-<span class="hljs-params">xhdpi</span>-6144-<span class="hljs-params">dalvik</span>-<span class="hljs-params">heap</span>.<span class="hljs-params">mk</span>)</span><br><br></code></pre></td></tr></table></figure>

<p>  现代手机基本都是 6GB+ 了，所以直接用这个就好，然后的话对于老机型就去这个目录下找你对应的内存容量，加上就好了</p>
<p>  然后是这个标记设备出厂时的 Android 版本的 flag</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-comment"># Shipping API level</span><br>PRODUCT_SHIPPING_API_LEVEL := 29<br></code></pre></td></tr></table></figure>

<p>  是几就写几，特别重要不能写错，Android 版本与 API 版本的对应关系可以在 AOSP 文档里查到</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://endcredits.github.io/Crepuscular-Blog">Crepuscular Hans</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://endcredits.github.io/Crepuscular-Blog/post/%E5%87%9B%E5%87%9B%E7%9A%84ROM%E8%AF%BE%E5%A0%82-%E7%AC%94%E8%AE%B0.html">https://endcredits.github.io/Crepuscular-Blog/post/%E5%87%9B%E5%87%9B%E7%9A%84ROM%E8%AF%BE%E5%A0%82-%E7%AC%94%E8%AE%B0.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/30337499?v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Crepuscular-Blog/post/2022-Chinese-national-day.html"><img class="prev-cover" src="http://x0.ifengimg.com/res/2019/855A7E7B6D0AF80A577513EBE5DD64C969FFE6A9_size269_w600_h338.jpeg" onerror="onerror=null;src='/Crepuscular-Blog/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Happy birthday to my motherland -- China!</div></div></a></div><div class="next-post pull-right"><a href="/Crepuscular-Blog/post/Build-Kernel.html"><img class="next-cover" src="https://camo.githubusercontent.com/b5d933cd654170ee36b79df0e26df2bc772efa7c36bd2644f8a1cd7744061f69/68747470733a2f2f66646e322e67736d6172656e612e636f6d2f76762f706963732f7869616f6d692f7869616f6d692d7265646d692d6b33302d35672d322e6a7067" onerror="onerror=null;src='/Crepuscular-Blog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Build a Kernel for Redmi K30 5G by your self.</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/39017895?v=4" onerror="this.onerror=null;this.src='/Crepuscular-Blog/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Crepuscular Hans</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/Crepuscular-Blog/archives/"><div class="headline">Articles</div><div class="length-num">4</div></a><a href="/Crepuscular-Blog/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/Crepuscular-Blog/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/EndCredits"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Welcome to Crepuscular's Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">基本结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%83%E4%BB%AC%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">它们有什么用?</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Crepuscular-Blog/post/2022-Chinese-national-day.html" title="Happy birthday to my motherland -- China!"><img src="http://x0.ifengimg.com/res/2019/855A7E7B6D0AF80A577513EBE5DD64C969FFE6A9_size269_w600_h338.jpeg" onerror="this.onerror=null;this.src='/Crepuscular-Blog/img/404.jpg'" alt="Happy birthday to my motherland -- China!"/></a><div class="content"><a class="title" href="/Crepuscular-Blog/post/2022-Chinese-national-day.html" title="Happy birthday to my motherland -- China!">Happy birthday to my motherland -- China!</a><time datetime="2022-09-30T16:00:00.000Z" title="Created 2022-10-01 00:00:00">2022-10-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Crepuscular-Blog/post/%E5%87%9B%E5%87%9B%E7%9A%84ROM%E8%AF%BE%E5%A0%82-%E7%AC%94%E8%AE%B0.html" title="凛凛的ROM课堂 -- 笔记"><img src="https://avatars.githubusercontent.com/u/30337499?v=4" onerror="this.onerror=null;this.src='/Crepuscular-Blog/img/404.jpg'" alt="凛凛的ROM课堂 -- 笔记"/></a><div class="content"><a class="title" href="/Crepuscular-Blog/post/%E5%87%9B%E5%87%9B%E7%9A%84ROM%E8%AF%BE%E5%A0%82-%E7%AC%94%E8%AE%B0.html" title="凛凛的ROM课堂 -- 笔记">凛凛的ROM课堂 -- 笔记</a><time datetime="2022-09-26T04:23:24.000Z" title="Created 2022-09-26 12:23:24">2022-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Crepuscular-Blog/post/Build-Kernel.html" title="Build a Kernel for Redmi K30 5G by your self."><img src="https://camo.githubusercontent.com/b5d933cd654170ee36b79df0e26df2bc772efa7c36bd2644f8a1cd7744061f69/68747470733a2f2f66646e322e67736d6172656e612e636f6d2f76762f706963732f7869616f6d692f7869616f6d692d7265646d692d6b33302d35672d322e6a7067" onerror="this.onerror=null;this.src='/Crepuscular-Blog/img/404.jpg'" alt="Build a Kernel for Redmi K30 5G by your self."/></a><div class="content"><a class="title" href="/Crepuscular-Blog/post/Build-Kernel.html" title="Build a Kernel for Redmi K30 5G by your self.">Build a Kernel for Redmi K30 5G by your self.</a><time datetime="2022-07-19T16:00:00.000Z" title="Created 2022-07-20 00:00:00">2022-07-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Crepuscular-Blog/post/hello-world.html" title="Hello World"><img src="https://s2.loli.net/2022/09/26/DsNVLKnt1qaW3y7.jpg" onerror="this.onerror=null;this.src='/Crepuscular-Blog/img/404.jpg'" alt="Hello World"/></a><div class="content"><a class="title" href="/Crepuscular-Blog/post/hello-world.html" title="Hello World">Hello World</a><time datetime="1970-01-01T00:00:00.000Z" title="Created 1970-01-01 08:00:00">1970-01-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Crepuscular Hans</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/Crepuscular-Blog/js/utils.js"></script><script src="/Crepuscular-Blog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>